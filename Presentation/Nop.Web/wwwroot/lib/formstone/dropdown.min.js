(function(n){typeof define=="function"&&define.amd?define(["jquery","./core","./scrollbar","./touch"],n):n(jQuery,Formstone)})(function(n,t){"use strict";function k(){c=t.$body}function d(f){var s,h,e;f.multiple=this.prop("multiple");f.disabled=this.prop("disabled")||this.is("[readonly]");f.lastIndex=!1;f.native=f.mobile||f.native;f.useNative=f.native||t.isMobile;f.multiple?f.links=!1:f.external&&(f.links=!0);var k=this.find("[selected]").not(":disabled"),c=this.find(":selected").not(":disabled"),y=c.text(),p=this.find("option").index(c);f.multiple||f.label===""||k.length?f.label="":(c=this.prepend('<option value="" class="'+i.item_placeholder+'" selected>'+f.label+"<\/option>"),y=f.label,p=0);var b=this.find("option, optgroup"),d=b.filter("option"),v=n('[for="'+this.attr("id")+'"]');f.tabIndex=this[0].tabIndex;this[0].tabIndex=-1;v.length&&(v[0].tabIndex=-1);s=[i.base,f.theme,f.customClass];f.useNative?s.push(i.native):f.cover&&s.push(i.cover);f.multiple&&s.push(i.multiple);f.disabled&&s.push(i.disabled);f.id=this.attr("id");f.ariaId=f.id?f.id:f.rawGuid;f.ariaId+="-dropdown";f.selectedAriaId=f.ariaId+"-selected";h="";e="";h+='<div class="'+s.join(" ")+'"id="'+f.ariaId+'" tabindex="'+f.tabIndex+'" role="listbox"';h+=f.multiple?' aria-label="multi select"':' aria-haspopup="true" aria-live="polite" aria-labelledby="'+f.selectedAriaId+'"';h+="><\/div>";f.multiple||(e+='<button type="button" class="'+i.selected+'" id="'+f.selectedAriaId+'" tabindex="-1">',e+=n("<span><\/span>").text(w(y,f.trim)).html(),e+="<\/button>");e+='<div class="'+i.options+'">';e+="<\/div>";this.wrap(h).after(e);f.$dropdown=this.parent(u.base);f.$label=v;f.$allOptions=b;f.$options=d;f.$selected=f.$dropdown.find(u.selected);f.$wrapper=f.$dropdown.find(u.options);f.$placeholder=f.$dropdown.find(u.placeholder);f.index=-1;f.closed=!0;f.focused=!1;l(f);f.multiple||o(p,f);n.fn.fsScrollbar!==undefined&&f.$wrapper.fsScrollbar({theme:f.theme}).find(".fs-scrollbar-content").attr("tabindex",null);f.$dropdown.on(r.click,f,a);f.$selected.on(r.click,f,a);f.$dropdown.on(r.click,u.item,f,ft).on(r.close,f,ut);this.on(r.change,f,et);if(!f.useNative){this.on(r.focusIn,f,function(n){n.data.$dropdown.trigger(r.raw.focus)});f.$dropdown.on(r.focusIn,f,ot).on(r.focusOut,f,st)}}function g(t){t.$dropdown.hasClass(i.open)&&t.$selected.trigger(r.click);n.fn.fsScrollbar!==undefined&&t.$wrapper.fsScrollbar("destroy");t.$el[0].tabIndex=t.tabIndex;t.$label.length&&(t.$label[0].tabIndex=t.tabIndex);t.$dropdown.off(r.namespace);t.$options.off(r.namespace);t.$placeholder.remove();t.$selected.remove();t.$wrapper.remove();t.$el.off(r.namespace).show().unwrap()}function nt(n,t){if(typeof t!="undefined"){var u=n.$items.index(n.$items.filter("[data-value="+t+"]"));n.$items.eq(u).addClass(i.item_disabled);n.$options.eq(u).prop("disabled",!0)}else n.$dropdown.hasClass(i.open)&&n.$selected.trigger(r.click),n.$dropdown.addClass(i.disabled),n.$el.prop("disabled",!0),n.disabled=!0}function tt(n,t){if(typeof t!="undefined"){var r=n.$items.index(n.$items.filter("[data-value="+t+"]"));n.$items.eq(r).removeClass(i.item_disabled);n.$options.eq(r).prop("disabled",!1)}else n.$dropdown.removeClass(i.disabled),n.$el.prop("disabled",!1),n.disabled=!1}function it(t){n.fn.fsScrollbar!==undefined&&t.$wrapper.fsScrollbar("destroy");var i=t.index;t.$allOptions=t.$el.find("option, optgroup");t.$options=t.$allOptions.filter("option");t.index=-1;i=t.$options.index(t.$options.filter(":selected"));l(t);t.multiple||o(i,t);n.fn.fsScrollbar!==undefined&&t.$wrapper.fsScrollbar({theme:t.theme}).find(".fs-scrollbar-content").attr("tabindex",null)}function l(t){for(var r,o,e="",a=0,h=0,v=t.$allOptions.length;h<v;h++)if(r=t.$allOptions.eq(h),o=[],r[0].tagName==="OPTGROUP")o.push(i.group),r.prop("disabled")&&o.push(i.disabled),e+='<span class="'+o.join(" ")+'">'+r.attr("label")+"<\/span>";else{var c=r.val(),l=r.data("label"),s=t.links?"a":'button type="button"';r.attr("value")||r.attr("value",c);o.push(i.item);r.hasClass(i.item_placeholder)&&(o.push(i.item_placeholder),s="span");r.prop("selected")&&o.push(i.item_selected);r.prop("disabled")&&o.push(i.item_disabled);e+="<"+s+' class="'+o.join(" ")+'"';t.links?s==="span"?e+=' aria-hidden="true"':(e+=' href="'+c+'"',t.external&&(e+=' target="_blank"')):e+=' data-value="'+c+'"';e+=' role="option"';r.prop("selected")&&(e+=' "aria-selected"="true"');e+=">";e+=l?l:f.decodeEntities(w(r.text(),t.trim));e+="<\/"+s+">";a++}t.$items=t.$wrapper.html(n.parseHTML(e)).find(u.item)}function a(n){f.killEvent(n);var t=n.data;t.disabled||t.useNative||(t.closed?y(t):e(t));v(t)}function v(t){n(u.base).not(t.$dropdown).trigger(r.close,[t])}function y(n){if(n.closed){var t=lt.height(),f=n.$wrapper.outerHeight(!0),e=n.$dropdown[0].getBoundingClientRect();e.bottom+f>t-n.bottomEdge&&n.$dropdown.addClass(i.bottom);c.on(r.click+n.dotGuid,":not("+u.options+")",n,rt);n.$dropdown.trigger(r.focusIn);n.$dropdown.addClass(i.open);p(n);n.closed=!1}}function e(n){n&&!n.closed&&(c.off(r.click+n.dotGuid),n.$dropdown.removeClass([i.open,i.bottom].join(" ")),n.closed=!0)}function rt(t){f.killEvent(t);var i=t.data;i&&n(t.currentTarget).parents(u.base).length===0&&(e(i),i.$dropdown.trigger(r.focusOut))}function ut(n){var t=n.data;t&&(e(t),t.$dropdown.trigger(r.focusOut))}function ft(t){var h=n(this),i=t.data,u;f.killEvent(t);i.disabled||(u=i.$items.index(h),i.focusIndex=u,i.$wrapper.is(":visible")&&(o(u,i,t.shiftKey,t.metaKey||t.ctrlKey),s(i)),i.multiple||e(i),i.$dropdown.trigger(r.focus))}function et(t,i){var f=n(this),r=t.data,u;i||r.multiple||(u=r.$options.index(r.$options.filter(":selected")),r.focusIndex=u,o(u,r),s(r,!0))}function ot(t){f.killEvent(t);var e=n(t.currentTarget),u=t.data;if(!u.disabled&&!u.multiple&&!u.focused){v(u);u.focused=!0;u.focusIndex=u.index;u.input="";u.$dropdown.addClass(i.focus).on(r.keyDown+u.dotGuid,u,ht)}}function st(t){f.killEvent(t);var o=n(t.currentTarget),u=t.data;u.focused&&u.closed&&(u.focused=!1,u.$dropdown.removeClass(i.focus).off(r.keyDown+u.dotGuid),u.multiple||(e(u),u.index!==u.focusIndex&&(s(u),u.focusIndex=u.index)))}function ht(i){var r=i.data,c,u,a,l,h;if(r.keyTimer=f.startTimer(r.keyTimer,1e3,function(){r.input=""}),i.keyCode===13)r.closed||(e(r),o(r.index,r)),s(r);else if(i.keyCode!==9&&!i.metaKey&&!i.altKey&&!i.ctrlKey&&!i.shiftKey){if(f.killEvent(i),c=r.$items.length-1,u=r.index<0?0:r.index,n.inArray(i.keyCode,t.isFirefox?[38,40,37,39]:[38,40])>-1)u=u+(i.keyCode===38||t.isFirefox&&i.keyCode===37?-1:1),u<0&&(u=0),u>c&&(u=c);else{for(a=String.fromCharCode(i.keyCode).toUpperCase(),r.input+=a,h=r.index+1;h<=c;h++)if(l=r.$options.eq(h).text().substr(0,r.input.length).toUpperCase(),l===r.input){u=h;break}if(u<0||u===r.index)for(h=0;h<=c;h++)if(l=r.$options.eq(h).text().substr(0,r.input.length).toUpperCase(),l===r.input){u=h;break}}u>=0&&(o(u,r),p(r))}}function o(n,t,r,f){var e=t.$items.eq(n),o=t.$options.eq(n),c=e.hasClass(i.item_selected),a=e.hasClass(i.item_disabled),s,h,l;a||(t.multiple?t.useNative?c?(o.prop("selected",null).attr("aria-selected",null),e.removeClass(i.item_selected)):(o.prop("selected",!0).attr("aria-selected",!0),e.addClass(i.item_selected)):r&&t.lastIndex!==!1?(s=t.lastIndex>n?n:t.lastIndex,h=(t.lastIndex>n?t.lastIndex:n)+1,t.$options.prop("selected",null).attr("aria-selected",null),t.$items.filter(u.item_selected).removeClass(i.item_selected),t.$options.slice(s,h).not("[disabled]").prop("selected",!0),t.$items.slice(s,h).not(u.item_disabled).addClass(i.item_selected)):f||t.selectMultiple?(c?(o.prop("selected",null).attr("aria-selected",null),e.removeClass(i.item_selected)):(o.prop("selected",!0).attr("aria-selected",!0),e.addClass(i.item_selected)),t.lastIndex=n):(t.$options.prop("selected",null).attr("aria-selected",null),t.$items.filter(u.item_selected).removeClass(i.item_selected),o.prop("selected",!0).attr("aria-selected",!0),e.addClass(i.item_selected),t.lastIndex=n):n>-1&&n<t.$items.length?n!==t.index&&(l=o.data("label")||e.html(),t.$selected.html(l).removeClass(u.item_placeholder),t.$items.filter(u.item_selected).removeClass(i.item_selected),t.$el[0].selectedIndex=n,e.addClass(i.item_selected),t.index=n):t.label!==""&&t.$selected.html(t.label))}function p(t){var r=t.$items.eq(t.index),u=t.index>=0&&!r.hasClass(i.item_placeholder)?r.position():{left:0,top:0},f=(t.$wrapper.outerHeight()-r.outerHeight())/2;n.fn.fsScrollbar!==undefined?t.$wrapper.fsScrollbar("resize").fsScrollbar("scroll",t.$wrapper.find(".fs-scrollbar-content").scrollTop()+u.top):t.$wrapper.scrollTop(t.$wrapper.scrollTop()+u.top-f)}function s(n,t){n.links?ct(n):t||n.$el.trigger(r.raw.change,[!0])}function ct(n){var t=n.$el.val();n.external?b.open(t):b.location.href=t}function w(n,t){return t===0?n:n.length>t?n.substring(0,t)+"...":n}var h=t.Plugin("dropdown",{widget:!0,defaults:{bottomEdge:0,cover:!1,customClass:"",label:"",external:!1,links:!1,mobile:!1,"native":!1,theme:"fs-light",trim:0,selectMultiple:!1},methods:{_construct:d,_destruct:g,disable:nt,enable:tt,update:it,open:y,close:e},classes:["cover","bottom","multiple","mobile","native","open","disabled","focus","selected","options","group","item","item_disabled","item_selected","item_placeholder"],events:{close:"close"}}),u=h.classes,i=u.raw,r=h.events,f=h.functions,b=t.window,lt=t.$window,vt=t.document,c=null;t.Ready(k)});